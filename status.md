# Project Status — BeyondChats Revision App
- **Repo path analyzed**: d:\BChat\chatGit\beyondchats-revision-app
- **Date**: October 8, 2025
- **Generated by**: Copilot static analysis

## Quick validation checklist
Run these commands locally to validate this analysis:
```bash
# Check if services start correctly
cd server && npm install && npm run dev &
cd client && npm install && npm run dev &

# Verify API endpoints
curl http://localhost:5000/api/health
curl -X POST http://localhost:5000/api/upload -F "pdf=@sample.pdf"

# Check environment variables
cat server/.env.example
```

## 1. Quick summary
BeyondChats is a full-stack RAG (Retrieval-Augmented Generation) application that allows users to upload PDFs, chat with their content via AI, and generate quizzes. The backend uses Nebius AI for LLM/embeddings and Supabase for vector storage. The frontend is React/Vite with Tailwind CSS. Most core functionality is implemented but has gaps in error handling, authentication integration, and progress persistence.

## 2. How to run (inferred)
**Frontend:**
```bash
cd client && npm install && npm run dev  # Runs on port 3000
```

**Backend:**
```bash
cd server && npm install && npm run dev  # Runs on port 5000 with nodemon
```

**Environment variables required:**
- `NEBIUS_API_KEY` - For LLM and embeddings API
- `SUPABASE_URL` - Vector database URL
- `SUPABASE_KEY` - Supabase anon key
- `VITE_API_URL` - Frontend API base URL (client)
- `VITE_SUPABASE_URL` - Client-side Supabase URL
- `VITE_SUPABASE_ANON_KEY` - Client-side Supabase key

**Build commands:**
- `npm run build` (client)
- `docker-compose up --build` for containerized deployment

## 3. Architecture overview
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   React     │───▶│   Express   │───▶│  Supabase   │    │   Nebius    │
│   Client    │    │   Server    │    │ (Vectors +  │◀───│  (LLM +     │
│  (Port 3000)│    │ (Port 5000) │    │  Auth)      │    │ Embeddings) │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
        │                   │                   │
        │                   │                   │
        ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ localStorage│    │File Uploads │    │pdf_chunks   │
│(Chat/Quiz)  │    │(/uploads/)  │    │table        │
└─────────────┘    └─────────────┘    └─────────────┘
```

**Data flow:** User uploads PDF → Server extracts text → Chunks text → Generates embeddings via Nebius → Stores in Supabase → User chats → Retrieves relevant chunks → Sends to Nebius LLM → Returns contextualized response.

## 4. Frontend — detailed status

**Key components:**
- `client/src/App.jsx` — Main app container, manages chat state via localStorage, handles API calls to `/api/chat`
- `client/src/components/ChatWindow.jsx` — Chat interface, calls `/api/generate-quiz` for quiz generation
- `client/src/components/ChatSidebar.jsx` — RAG chat + quiz UI, calls `/api/rag-query`, `/api/save-attempt`, `/api/progress/{id}`
- `client/src/components/PDFViewer.jsx` — PDF display component, calls `/api/extract-text`
- `client/src/components/SourceSelector.jsx` — File upload UI, calls `/api/upload-pdf`, `/api/list-pdfs`
- `client/src/components/QuizRenderer.jsx` — Quiz display and interaction
- `client/src/components/EnhancedQuizRenderer.jsx` — Advanced quiz with analytics, calls `/api/analyze-quiz`
- `client/src/context/AuthContext.jsx` — Supabase auth wrapper, calls `/api/auth/profile`

**Routing & pages:**
- `/` → `pages/Home.jsx` (main app)
- `/login` → `pages/Login.jsx` (authentication)
- `/auth/callback` → `pages/AuthCallback.jsx` (OAuth callback)
- `/viewer` → `pages/Viewer.jsx` (PDF viewer)

**State management:** 
- localStorage for chat history (`beyondchats_data` key)
- React Context for authentication
- Component-level state for UI interactions

**API usage:**
```javascript
// Chat API call in App.jsx:129
const response = await fetch(`${import.meta.env.VITE_API_URL || 'http://localhost:5000'}/api/chat`, {...})

// Quiz generation in ChatSidebar.jsx:121
const response = await fetch('http://localhost:5000/api/generate-quiz', {...})

// Progress saving in ChatSidebar.jsx:150
const response = await fetch('http://localhost:5000/api/save-attempt', {...})
```

**Known frontend issues:**
- Hard-coded localhost URLs instead of environment variables in multiple components
- Missing error boundaries for component crashes
- Progress API endpoints called but corresponding server routes don't exist (`/api/progress/{id}`)
- Quiz attempt saving calls `/api/save-attempt` but doesn't handle failures gracefully

## 5. Backend — detailed status

**Key server files:**
- `server/server.js` — Main server entry point, route mounting, database initialization
- `server/routes/index.js` — Route aggregation and API health endpoint
- `server/routes/chat.js` — RAG chat endpoint (`POST /api/chat`)
- `server/routes/quiz.js` — Quiz generation (`POST /api/generate-quiz`) and analysis (`POST /api/analyze-quiz`)
- `server/routes/files.js` — File upload (`POST /api/upload`) and text extraction (`POST /api/extract-text`)
- `server/routes/embeddings.js` — Embedding creation and vector search
- `server/routes/auth.js` — Authentication routes (Supabase integration)
- `server/embeddings.js` — Nebius AI embedding generation and Supabase vector operations
- `server/config/index.js` — Environment configuration and constants

**Implemented endpoints:**
- `GET /api/health` — Health check (routes/index.js:18)  
- `POST /api/upload` — PDF file upload (routes/files.js:14)
- `POST /api/extract-text` — PDF text extraction (routes/files.js:33)
- `POST /api/chat` — RAG chat with context (routes/chat.js:11)
- `POST /api/generate-quiz` — AI quiz generation (routes/quiz.js:16)
- `POST /api/analyze-quiz` — Quiz performance analysis (routes/quiz.js)
- `POST /api/create-embeddings` — Generate and store embeddings (routes/embeddings.js)
- `POST /api/search-chunks` — Vector similarity search (routes/embeddings.js)

**DB interactions:**
- Supabase client initialized in `embeddings.js:14`
- Main table: `pdf_chunks` (id, pdf_id, page, text, embedding, chunk_index, created_at)
- Vector search function: `search_pdf_chunks()` in `database/supabase_schema.sql:27`

**LLM & embeddings integration:**
- Nebius API client in `embeddings.js:8` and `routes/quiz.js:9`
- Chat model: `Qwen/Qwen3-235B-A22B-Thinking-2507`
- Embedding model: `Qwen/Qwen3-Embedding-8B` (4096 dimensions)
- OpenAI client configured to use Nebius endpoint

**Known backend issues:**
- Missing `/api/save-attempt` endpoint (frontend calls it but doesn't exist)
- Missing `/api/progress/{id}` endpoint (frontend expects this)
- Missing `/api/list-pdfs` and `/api/upload-pdf` endpoints referenced by frontend
- Error in ChatSidebar: calls `/api/rag-query` but server only has `/api/chat`
- No transaction safety for database operations
- Missing input validation on several endpoints

## 6. Data schemas & storage

**Supabase tables (inferred from schema):**
- `pdf_chunks` — (id, pdf_id, page, text, embedding VECTOR(4096), chunk_index, created_at)
- `users` — (implied by auth context but schema not found)
- `chat_sessions` — (implied by chat storage but not implemented)
- `quiz_attempts` — (implied by save-attempt calls but not implemented)

**localStorage usage:**
- Key: `beyondchats_data` (App.jsx:12)
- Stores: `{chats: [], pdfs: [], quizzes: [], progress: {}}`
- Used for chat history, quiz attempts, and progress tracking
- Managed by `getStoredData()` and `saveStoredData()` functions in App.jsx

**Vector embeddings:**
- Stored in Supabase as VECTOR(4096) type
- Generated via Nebius Qwen3-Embedding-8B model
- Similarity search using cosine distance (`<=>` operator in PostgreSQL)

## 7. Current blockers / bugs (concrete)

1. **Missing API endpoints**: Frontend calls `/api/save-attempt`, `/api/progress/{id}`, `/api/list-pdfs`, `/api/upload-pdf`, `/api/rag-query` but these don't exist in server routes.
   - Root cause: Frontend-backend API contract mismatch

2. **Hard-coded URLs**: Components use `http://localhost:5000` instead of environment variables.
   - Location: ChatSidebar.jsx:67, ChatWindow.jsx:37, PDFViewer.jsx:24, etc.
   - Root cause: Missing VITE_API_URL usage in components

3. **Quiz attempt persistence broken**: `handleQuizComplete()` in ChatSidebar.jsx:150 calls non-existent `/api/save-attempt`.
   - Root cause: Missing server-side quiz attempt storage implementation

4. **Progress loading fails**: `loadProgress()` in ChatSidebar.jsx:28 calls missing `/api/progress/{id}` endpoint.
   - Root cause: Progress persistence not implemented on backend

5. **Authentication not integrated**: AuthContext exists but user ID not passed to API calls.
   - Location: Most API calls in components don't include user context
   - Root cause: Authentication state not propagated to API requests

6. **Error handling gaps**: Many API calls lack try-catch or error state management.
   - Location: SourceSelector.jsx:54, PDFViewer.jsx:24
   - Root cause: Inconsistent error handling patterns

7. **Environment variable mismatch**: Server expects `NEBIUS_API_KEY`, client expects `VITE_*` vars.
   - Root cause: Environment variable naming not documented

## 8. Tests and CI

**Test files found:**
- `server/test-db.js` — Database connection test
- `server/test-chat.js` — Chat functionality test  
- `server/test/data/05-versions-space.pdf` — Test PDF file

**No CI/CD workflows found** — No `.github/workflows/` directory

**How to run tests:**
```bash
cd server && node test-db.js
cd server && node test-chat.js
```

## 9. Prioritized next steps (smallest-first)

1. **Fix hard-coded API URLs**
   - Why: Prevents deployment flexibility and breaks in production
   - Files: `client/src/components/*.jsx` 
   - Branch: `fix/api-url-env-vars`
   - Commit: `fix: replace hardcoded localhost with env vars`
   - Complexity: low

2. **Add missing save-attempt endpoint**
   - Why: Quiz completion currently fails silently
   - Files: `server/routes/quiz.js`, create quiz attempts table
   - Branch: `feat/save-quiz-attempts`
   - Commit: `feat: implement quiz attempt persistence`
   - Complexity: low

3. **Add missing progress endpoint**
   - Why: Progress loading fails on every PDF selection
   - Files: `server/routes/quiz.js` (add GET /api/progress/:id)
   - Branch: `feat/progress-api`
   - Commit: `feat: add progress tracking endpoint`
   - Complexity: low

4. **Fix RAG endpoint mismatch**
   - Why: Chat functionality broken (calls wrong endpoint)
   - Files: `client/src/components/ChatSidebar.jsx:67`
   - Branch: `fix/rag-endpoint-name`
   - Commit: `fix: correct RAG endpoint from /rag-query to /chat`
   - Complexity: low

5. **Add error boundaries to React components**
   - Why: Prevents component crashes from breaking entire app
   - Files: Create `client/src/components/ErrorBoundary.jsx`, update App.jsx
   - Branch: `feat/error-boundaries`
   - Commit: `feat: add React error boundaries for robustness`
   - Complexity: low

6. **Implement missing file management endpoints**
   - Why: PDF listing and uploading currently broken
   - Files: `server/routes/files.js` (add list-pdfs, upload-pdf routes)
   - Branch: `feat/file-management-api`
   - Commit: `feat: add PDF listing and upload endpoints`
   - Complexity: medium

7. **Add user authentication to API calls**
   - Why: Multi-user support requires user context in requests
   - Files: Update all API calls to include auth headers
   - Branch: `feat/authenticated-api-calls`
   - Commit: `feat: integrate user auth with API requests`
   - Complexity: medium

8. **Add comprehensive error handling**
   - Why: Improves user experience and debugging
   - Files: All API-calling components, server route handlers
   - Branch: `feat/error-handling`
   - Commit: `feat: add comprehensive error handling and user feedback`
   - Complexity: medium

9. **Create database migrations for missing tables**
   - Why: Chat sessions and quiz attempts need persistent storage  
   - Files: `server/database/` (new migration files)
   - Branch: `feat/database-schema-complete`
   - Commit: `feat: add chat sessions and quiz attempts tables`
   - Complexity: medium

10. **Add unit tests for API endpoints**
    - Why: Ensures reliability and prevents regressions
    - Files: `server/test/` (new test files for each route)
    - Branch: `feat/api-unit-tests`
    - Commit: `feat: add comprehensive API endpoint tests`
    - Complexity: high

## 10. Safe edit & deployment guidance

**Safe workflow for changes:**
1. Create feature branch: `git checkout -b feat/your-change`
2. Make minimal, focused changes
3. Test locally: `npm run dev` in both client and server
4. Check API endpoints with curl/Postman
5. Commit with descriptive message: `git commit -m "feat: specific change description"`
6. Push branch: `git push origin feat/your-change`
7. Create pull request for review
8. Merge to main only after testing

**To revert changes:**
```bash
# Revert last commit
git revert HEAD

# Reset to previous state (DANGEROUS)
git reset --hard HEAD~1

# Stash uncommitted changes
git stash push -m "temporary changes"
```

**Feature flag approach for big changes:**
```javascript
// Add to config
const FEATURE_FLAGS = {
  USE_NEW_QUIZ_ENGINE: process.env.ENABLE_NEW_QUIZ === 'true'
}

// Use in code
if (FEATURE_FLAGS.USE_NEW_QUIZ_ENGINE) {
  // new implementation
} else {
  // old implementation  
}
```

## 11. TODOs & questions for the author

- **TODO: Clarify authentication flow** — Is Google OAuth the primary auth method? Should all API calls require authentication?
- **TODO: Vector search configuration** — Are the current embedding dimensions (4096) and similarity thresholds optimal for your use case?
- **TODO: LLM model selection** — Is `Qwen/Qwen3-235B-A22B-Thinking-2507` the intended production model or for testing?
- **TODO: Deployment target** — Are you deploying to Vercel, Railway, AWS, or self-hosted? This affects environment variable setup.
- **TODO: Data retention policy** — How long should chat sessions and quiz attempts be retained?
- **TODO: Rate limiting** — Should API endpoints have rate limiting, especially for expensive LLM calls?
- **TODO: File storage** — Should uploaded PDFs be stored in Supabase Storage or keep local filesystem?

## 12. Appendices

**Crucial code snippets:**

*Progress saving attempt (ChatSidebar.jsx:150):*
```javascript
const response = await fetch('http://localhost:5000/api/save-attempt', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    fileId: selectedFile?.id, quiz: quiz, results: results, timestamp: new Date().toISOString()
  })
})
```

*Vector search implementation (embeddings.js:45):*
```javascript
const response = await nebiusClient.embeddings.create({
  model: process.env.EMBED_MODEL || "Qwen/Qwen3-Embedding-8B",
  input: text
});
```

*API endpoint definitions (routes/index.js:12):*
```javascript
router.use('/api', filesRouter)
router.use('/api', chatRouter)  
router.use('/api', embeddingsRouter)
router.use('/api', quizRouter)
```

**Files requiring manual review:**
- `server/routes/quiz.js` (710 lines) — Complex quiz generation logic
- `client/src/App.jsx` (319 lines) — Main application state management  
- `server/embeddings.js` (307 lines) — Core RAG functionality
- All components in `client/src/components/` — API integration points

---
*This analysis was generated by static code analysis. Some runtime behaviors and dynamic configurations may not be captured. Run the validation checklist above to verify findings.*